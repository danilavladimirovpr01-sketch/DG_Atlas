# План: Расширение NPS + Замена этапов строительства

## Контекст
Текущие 14 этапов в коде неправильные. Заменяем на реальные с лендинга DG Atlas v2 + добавляем этап "Тёплый контур" (итого 15 этапов, нумерация 0-14). NPS полностью переделываем: на каждом этапе свой набор вопросов (все оценки 0-10, последний — текстовый отзыв). **NPS привязан к конкретному сотруднику** — клиент выбирает, кого оценивает. Статистика подбивается по людям. В админке появляется отдельный раздел NPS.

---

## 1. Новые 15 этапов строительства (0-14)

### Файл: `lib/constants/stages.ts`

| # | slug | Название | Описание | Тип сотрудника |
|---|------|----------|----------|----------------|
| 0 | mechta | Мечта | Формирование бюджета и видения | Менеджер |
| 1 | uchastok | Участок | Кадастр, ГПЗУ, посадка дома | Менеджер |
| 2 | kompaniya | Компания | Проверка надёжности, видео-обзоры | Менеджер |
| 3 | proektirovanie | Проектирование | Выбор проекта + документация | Архитектор |
| 4 | smeta | Смета | Раздельная по этапам с индексацией | Менеджер |
| 5 | fundament-steny | Фундамент и стены | Заливка + возведение стен | Прораб |
| 6 | krysha | Крыша | Монтаж кровли | Прораб |
| 7 | teplyj-kontur | Тёплый контур завершён | Дом закрыт | Менеджер проекта |
| 8 | fasad | Отделка фасада | Штукатурка, клинкер, панели | Прораб |
| 9 | dizajn-proekt | Дизайн-проект | Проект интерьера | Архитектор |
| 10 | otdelka | Внутренняя отделка | Отделочные работы | Прораб |
| 11 | kommunikacii | Инж. коммуникации | Электрика, отопление, канализация | Прораб |
| 12 | landshaft | Ландшафтный дизайн | Благоустройство, озеленение | Прораб |
| 13 | zaezd | Заезд | Передача ключей | Менеджер проекта |
| 14 | servis | Сервис | Гарантийное обслуживание | Менеджер |

---

## 2. Сотрудники (employees)

### Новая таблица `employees`
Отдельная от `profiles` (profiles — пользователи приложения, employees — сотрудники компании для оценки).

```sql
create table public.employees (
  id uuid primary key default gen_random_uuid(),
  full_name text not null,
  position text not null check (position in ('manager', 'architect', 'foreman', 'project_manager')),
  is_active boolean not null default true,
  created_at timestamptz not null default now()
);
```

**Должности:**
- `manager` — Менеджер (этапы 0, 1, 2, 4, 14)
- `architect` — Архитектор (этапы 3, 9)
- `foreman` — Прораб (этапы 5, 6, 8, 10, 11, 12)
- `project_manager` — Менеджер проекта (этапы 7, 13)

### Тестовые данные (seed)

**Менеджеры:**
- Алексей Петров
- Дмитрий Козлов
- Елена Смирнова

**Архитекторы:**
- Андрей Волков
- Мария Белова
- Сергей Новиков

**Прорабы:**
- Иван Сидоров
- Николай Кузнецов
- Павел Морозов

**Менеджеры проекта:**
- Ольга Васильева
- Артём Лебедев
- Татьяна Фёдорова

### Привязка этапа → должности

Файл: `lib/constants/stages.ts` — каждый этап содержит поле `employeePosition`:
```ts
{ number: 3, slug: 'proektirovanie', title: 'Проектирование', employeePosition: 'architect' }
{ number: 7, slug: 'teplyj-kontur', title: 'Тёплый контур', employeePosition: 'project_manager' }
```

### Поведение в NPS-виджете
1. Клиент открывает NPS для этапа
2. Первый экран: **выбор сотрудника** из списка (фильтр по `position` этапа)
3. Дальше — вопросы с оценками 0-10
4. `employee_id` сохраняется в `nps_responses`

---

## 3. NPS-вопросы по этапам

**Формат**: все оценочные вопросы — шкала 0-10. Последний вопрос — свободный текст.
**Хранение**: JSONB колонка `answers` + `employee_id`.

### Этап 0 — Мечта (Менеджер)
1. Насколько понятно специалист объяснил этапы строительства и что вас ожидает?
2. Насколько вам помогли определиться с бюджетом и общей концепцией дома?
3. Насколько вежливым и внимательным был специалист при первой консультации?
4. Насколько оперативно с вами связались после обращения?
5. Насколько вы в целом довольны первым этапом взаимодействия с компанией?
6. *Текст:* Покритикуйте нас — что можно улучшить на этапе первого знакомства?

### Этап 1 — Участок (Менеджер)
1. Насколько полно специалист проконсультировал вас по выбору и проверке участка?
2. Насколько понятно были объяснены документы (кадастр, ГПЗУ)?
3. Насколько вежливым и доброжелательным был специалист?
4. Насколько оперативно вам предоставляли информацию по участку?
5. Насколько понятно была показана посадка дома на участке?
6. Насколько вы в целом довольны работой на этапе подбора участка?
7. *Текст:* Что можно улучшить на этом этапе?

### Этап 2 — Компания (Менеджер)
1. Насколько убедительно компания продемонстрировала свою надёжность и опыт?
2. Насколько понятно и полно вам рассказали об условиях сотрудничества?
3. Насколько вежливым и доброжелательным был менеджер при знакомстве с компанией?
4. Насколько оперативно менеджер отвечал на ваши вопросы?
5. Насколько полезными были видео-обзоры и отзывы других клиентов?
6. Насколько вы в целом довольны этапом знакомства с компанией?
7. *Текст:* Что вам не понравилось на этом этапе?

### Этап 3 — Проектирование (Архитектор) ✅ вопросы от заказчика
1. Насколько архитектор учёл ваши пожелания и требования при разработке проекта?
2. Насколько понятно и подробно специалист объяснял решения по планировке и дизайну?
3. Насколько вежливым и доброжелательным был архитектор в процессе общения?
4. Насколько вы удовлетворены оперативностью ответов архитектора?
5. Насколько ясно и наглядно были представлены чертежи и визуальные материалы (эскизы, рендеры)?
6. Насколько вы в целом довольны итоговым результатом архитектурного проектирования?
7. *Текст:* Покритикуйте нас, что вам не понравилось на этом этапе взаимодействия с нашей компанией?

### Этап 4 — Смета (Менеджер)
1. Насколько понятно и прозрачно была составлена смета?
2. Насколько подробно специалист объяснил каждую статью расходов?
3. Насколько вежливым и доброжелательным был специалист при обсуждении сметы?
4. Насколько оперативно были подготовлены и скорректированы сметные документы?
5. Насколько цена соответствует вашим ожиданиям и рыночным реалиям?
6. Насколько вы в целом довольны работой на этапе составления сметы?
7. *Текст:* Что можно улучшить на этом этапе?

### Этап 5 — Фундамент и стены (Прораб)
1. Насколько качественно выполнены работы по фундаменту?
2. Насколько качественно возведены стены?
3. Насколько вежливым и доброжелательным был прораб на площадке?
4. Насколько оперативно вас информировали о ходе строительства?
5. Насколько соблюдались заявленные сроки на этом этапе?
6. Насколько вы в целом довольны результатом этапа «Фундамент и стены»?
7. *Текст:* Что можно улучшить на этом этапе?

### Этап 6 — Крыша (Прораб)
1. Насколько качественно выполнен монтаж кровли?
2. Насколько понятно вам объяснили выбор кровельных материалов и конструкцию?
3. Насколько вежливым и доброжелательным был прораб?
4. Насколько оперативно вас информировали о ходе работ?
5. Насколько соблюдались заявленные сроки?
6. Насколько вы в целом довольны результатом этапа «Крыша»?
7. *Текст:* Что можно улучшить?

### Этап 7 — Тёплый контур завершён (Менеджер проекта) ✅ вопросы от заказчика
1. Насколько менеджер проектов чётко и своевременно решал организационные вопросы в ходе строительства?
2. Насколько вежливым и доброжелательным был менеджер проектов при взаимодействии с вами?
3. Насколько полно и понятно менеджер проектов консультировал вас по процессу строительства (срокам, этапам, необходимым решениям)?
4. Как вы оцениваете качество подготовки и оформления документов (актов, смет, отчётов) со стороны менеджера проектов?
5. Насколько оперативно менеджер проектов отвечал на ваши обращения и запросы?
6. Насколько вы в целом довольны уровнем сопровождения, которое обеспечивал менеджер проектов на этапе строительства?
7. Как вы оцениваете организацию стройплощадки (прораб, порядок, качество)?
8. *Текст:* Если вы хотите что-то добавить, пожалуйста, напишите в ответном сообщении

### Этап 8 — Отделка фасада (Прораб)
1. Насколько качественно выполнена отделка фасада?
2. Насколько результат соответствует выбранному вами варианту (материал, цвет)?
3. Насколько вежливым и доброжелательным был прораб?
4. Насколько оперативно вас информировали о ходе работ?
5. Насколько соблюдались заявленные сроки?
6. Насколько вы в целом довольны внешним видом фасада?
7. *Текст:* Что можно улучшить?

### Этап 9 — Дизайн-проект (Архитектор)
1. Насколько дизайнер учёл ваши пожелания и стиль жизни при разработке интерьера?
2. Насколько понятно и наглядно были представлены визуализации интерьера?
3. Насколько вежливым и доброжелательным был дизайнер в процессе общения?
4. Насколько оперативно дизайнер вносил корректировки?
5. Насколько вы довольны подбором материалов и цветовых решений?
6. Насколько вы в целом довольны итоговым дизайн-проектом?
7. *Текст:* Что можно улучшить?

### Этап 10 — Внутренняя отделка (Прораб)
1. Насколько качественно выполнены отделочные работы (стены, потолки, полы)?
2. Насколько результат соответствует утверждённому дизайн-проекту?
3. Насколько вежливым и доброжелательным был прораб?
4. Насколько оперативно вас информировали о ходе работ?
5. Насколько соблюдались заявленные сроки?
6. Насколько вы в целом довольны результатом внутренней отделки?
7. *Текст:* Что можно улучшить?

### Этап 11 — Инженерные коммуникации (Прораб)
1. Насколько качественно смонтированы инженерные системы (электрика, отопление, водоснабжение)?
2. Насколько понятно вам объяснили схемы коммуникаций и правила эксплуатации?
3. Насколько вежливым и доброжелательным был специалист?
4. Насколько оперативно выполнялись работы?
5. Насколько удобно расположены розетки, выключатели и сантехника?
6. Насколько вы в целом довольны инженерными коммуникациями?
7. *Текст:* Что можно улучшить?

### Этап 12 — Ландшафтный дизайн (Прораб)
1. Насколько качественно выполнено благоустройство участка?
2. Насколько результат соответствует согласованному плану?
3. Насколько вежливым и доброжелательным был специалист по ландшафту?
4. Насколько оперативно выполнялись работы?
5. Насколько вы довольны качеством дорожек, отмостки, забора?
6. Насколько вы в целом довольны внешним видом участка?
7. *Текст:* Что можно улучшить?

### Этап 13 — Заезд (Менеджер проекта)
1. Насколько полно и своевременно вам передали все документы на дом?
2. Насколько понятно специалист объяснил правила эксплуатации и гарантийные условия?
3. Насколько вежливым и доброжелательным был специалист при передаче ключей?
4. Насколько оперативно были устранены замечания при приёмке?
5. Насколько ключи были переданы в заявленный срок?
6. Насколько вы в целом довольны процессом приёмки и заезда?
7. *Текст:* Поделитесь впечатлениями от вашего нового дома!

### Этап 14 — Сервис (Менеджер)
1. Насколько оперативно сервисная служба реагирует на ваши обращения?
2. Насколько качественно устраняются выявленные недостатки?
3. Насколько вежливым и доброжелательным был сервисный специалист?
4. Насколько понятно вам объяснили условия гарантийного обслуживания?
5. Насколько полезны предложения от партнёров компании?
6. Насколько вы в целом довольны гарантийным обслуживанием?
7. *Текст:* Что можно улучшить в сервисе?

---

## 4. Структура данных

### Новая таблица `employees`
```sql
create table public.employees (
  id uuid primary key default gen_random_uuid(),
  full_name text not null,
  position text not null check (position in ('manager', 'architect', 'foreman', 'project_manager')),
  is_active boolean not null default true,
  created_at timestamptz not null default now()
);
alter table public.employees enable row level security;
create policy "Service role full access" on public.employees for all using (auth.role() = 'service_role');
create policy "Anyone can read employees" on public.employees for select using (true);
```

### Обновление `nps_responses`
```sql
ALTER TABLE nps_responses ADD COLUMN employee_id uuid references public.employees(id) on delete set null;
ALTER TABLE nps_responses ADD COLUMN answers jsonb DEFAULT '{}';

-- Обновить unique constraint (теперь per client+project+stage+employee)
ALTER TABLE nps_responses DROP CONSTRAINT IF EXISTS nps_responses_client_id_project_id_stage_key;
ALTER TABLE nps_responses ADD CONSTRAINT nps_responses_unique UNIQUE (client_id, project_id, stage);
```

### Обновление constraints этапов (1-14 → 0-14)
```sql
ALTER TABLE projects DROP CONSTRAINT IF EXISTS projects_current_stage_check;
ALTER TABLE projects ADD CONSTRAINT projects_current_stage_check CHECK (current_stage BETWEEN 0 AND 14);
UPDATE projects SET current_stage = current_stage - 1;

ALTER TABLE stage_photos DROP CONSTRAINT IF EXISTS stage_photos_stage_check;
ALTER TABLE stage_photos ADD CONSTRAINT stage_photos_stage_check CHECK (stage BETWEEN 0 AND 14);
UPDATE stage_photos SET stage = stage - 1;

ALTER TABLE nps_responses DROP CONSTRAINT IF EXISTS nps_responses_stage_check;
ALTER TABLE nps_responses ADD CONSTRAINT nps_responses_stage_check CHECK (stage BETWEEN 0 AND 14);
UPDATE nps_responses SET stage = stage - 1;
```

### Seed: тестовые сотрудники
```sql
INSERT INTO employees (full_name, position) VALUES
  -- Менеджеры
  ('Алексей Петров', 'manager'),
  ('Дмитрий Козлов', 'manager'),
  ('Елена Смирнова', 'manager'),
  -- Архитекторы
  ('Андрей Волков', 'architect'),
  ('Мария Белова', 'architect'),
  ('Сергей Новиков', 'architect'),
  -- Прорабы
  ('Иван Сидоров', 'foreman'),
  ('Николай Кузнецов', 'foreman'),
  ('Павел Морозов', 'foreman'),
  -- Менеджеры проекта
  ('Ольга Васильева', 'project_manager'),
  ('Артём Лебедев', 'project_manager'),
  ('Татьяна Фёдорова', 'project_manager');
```

### Файл: `types/index.ts`
```ts
export type EmployeePosition = 'manager' | 'architect' | 'foreman' | 'project_manager';

export interface Employee {
  id: string;
  full_name: string;
  position: EmployeePosition;
  is_active: boolean;
  created_at: string;
}

export interface NpsResponse {
  id: string;
  client_id: string;
  project_id: string;
  employee_id: string | null;
  stage: number;        // 0-14
  score: number;        // 0-10 (последний оценочный вопрос = общая оценка)
  answers: Record<string, number | string>;
  comment: string | null;
  created_at: string;
}
```

### Файл: `lib/constants/nps-questions.ts`
```ts
interface NpsQuestion {
  key: string;
  label: string;
  type: 'rating' | 'text';
}

interface StageNpsConfig {
  employeePosition: EmployeePosition;
  questions: NpsQuestion[];
}

const NPS_QUESTIONS: Record<number, StageNpsConfig> = { ... }
```

---

## 5. NPS-виджет в TMA

### `components/tma/NpsWidget.tsx` — полная переделка
Пошаговый опрос:
1. **Шаг 0**: Выбор сотрудника (список по position этапа, загружается с API)
2. **Шаги 1-N**: По одному вопросу на экран, шкала 0-10 (кнопки как сейчас)
3. **Последний шаг**: Текстовое поле
4. **Финал**: "Спасибо!"

- Прогресс-бар наверху (напр. "3 из 8")
- Кнопки "Пропустить" / "Далее"
- На шаге выбора сотрудника — карточки с именами

### API для получения сотрудников
`GET /api/employees?position=architect` — возвращает список активных сотрудников по должности

---

## 6. Админка — раздел NPS

### `app/(dashboard)/admin/nps/page.tsx`

**KPI-карточки:**
- NPS Score (-100 до +100)
- Всего ответов
- Средняя оценка (avg score)
- Проблемный этап (этап с мин. средней оценкой)

**Таблица: Рейтинг сотрудников**
| Сотрудник | Должность | Ответов | Средняя оценка | NPS |
|-----------|-----------|---------|----------------|-----|
| Андрей Волков | Архитектор | 12 | 8.4 | +67 |
| Иван Сидоров | Прораб | 8 | 7.1 | +25 |

**Таблица: Оценки по этапам**
| Этап | Ответов | Средняя оценка |
|------|---------|----------------|

**Лента последних ответов:**
| Дата | Клиент | Этап | Сотрудник | Оценка | Комментарий |

### `components/layout/Sidebar.tsx`
Добавить: `{ href: '/admin/nps', label: 'NPS', icon: Star }`

---

## 7. Затронутые файлы

| Файл | Действие |
|------|----------|
| `supabase/migrations/002_update_stages_and_nps.sql` | Создать миграцию (этапы + employees + nps) |
| `lib/constants/stages.ts` | Переписать — 15 этапов с employeePosition |
| `lib/constants/nps-questions.ts` | Создать — вопросы по этапам |
| `types/index.ts` | Добавить Employee, EmployeePosition, обновить NpsResponse |
| `app/api/employees/route.ts` | Создать — GET список сотрудников |
| `app/api/nps/route.ts` | Расширить POST (answers + employee_id) |
| `app/api/nps/stats/route.ts` | Создать — GET статистика |
| `components/tma/NpsWidget.tsx` | Переписать — пошаговый опрос + выбор сотрудника |
| `components/tma/StagesTimeline.tsx` | Мелкие правки |
| `app/(dashboard)/admin/nps/page.tsx` | Создать — страница NPS с рейтингом сотрудников |
| `components/layout/Sidebar.tsx` | Добавить ссылку NPS |
| `app/api/tma/onboarding/route.ts` | current_stage: 0 |

## 8. Порядок реализации
1. Миграция БД (создать + выполнить в Supabase SQL Editor)
2. `lib/constants/stages.ts` — 15 этапов
3. `lib/constants/nps-questions.ts` — все вопросы
4. `types/index.ts` — обновить типы
5. `app/api/employees/route.ts` — GET сотрудники
6. `app/api/nps/route.ts` — расширить POST
7. `app/api/nps/stats/route.ts` — создать GET
8. `components/tma/NpsWidget.tsx` — переписать
9. `components/tma/StagesTimeline.tsx` — правки
10. `app/(dashboard)/admin/nps/page.tsx` — создать
11. `components/layout/Sidebar.tsx` — ссылка
12. `app/api/tma/onboarding/route.ts` — stage 0
13. `npm run build` — проверка
14. `git push` — деплой

## 9. Верификация
1. Запустить миграцию в Supabase SQL Editor
2. `npm run build` — нет TS/ESLint ошибок
3. TMA: онбординг → видим 15 новых этапов
4. TMA: завершённый этап → выбор сотрудника → пошаговый NPS-опрос → отправка
5. Админка: /admin/nps → KPI + рейтинг сотрудников + таблица по этапам + лента
6. git push → Vercel деплой
